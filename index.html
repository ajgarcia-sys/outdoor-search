<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Outdoor Search — Fresh Results</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 24px; }
    h1 { margin: 0 0 12px; font-size: 22px; }
    .note { color: #555; margin: 6px 0 14px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    input[type="text"], input[type="password"] { flex: 1 1 360px; padding: 10px 12px; font-size: 16px; }
    select, button, label { font-size: 14px; }
    button { padding: 10px 14px; cursor: pointer; }
    .results { margin-top: 18px; }
    .item { padding: 12px 0; border-bottom: 1px solid #eee; }
    .item a { font-weight: 600; text-decoration: none; }
    .meta { color: #666; font-size: 12px; margin-top: 2px; }
    .toolbar { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
    .hidden { display: none; }
    .error { color: #b00020; margin-top: 10px; }
    .small { font-size: 12px; color: #666; }
    .badge { display:inline-block; padding:2px 6px; border-radius:6px; background:#eef; color:#223; font-size:11px; margin-left:6px; }
    .pass { color:#0a7b0a; }
    .fail { color:#b00020; }
    details summary { cursor: pointer; }
    code.k { background:#f6f8fa; padding:2px 4px; border-radius:4px; }
  </style>
</head>
<body>
  <h1>Search (Fresh)<span class="badge">Option B · JSON API</span></h1>
  <p class="note">Type a thing. Pick a time window. Click <b>Search</b>. This filters old pages out (<code class="k">dateRestrict</code>) and sorts newest first (<code class="k">sort=date</code>).</p>

  <details open>
    <summary><b>Setup</b> — paste your keys (kept in this page only)</summary>
    <div class="row" style="margin-top:10px;">
      <input id="apiKey" type="password" placeholder="API key (from Google Cloud)" />
      <input id="cxId" type="text" placeholder="CX (Search engine ID) e.g. f3517fe67eda24a2e or 0123456789:abcd" />
      <button id="saveKeys">Use keys</button>
    </div>
    <p class="small">Tip: you can keep testing with no domain lock. Later, lock the key to your domain under <i>Application restrictions → HTTP referrers</i>.</p>
  </details>

  <div class="row" style="margin-top:12px;">
    <input id="q" type="text" placeholder="e.g., permit lottery yosemite" />
    <select id="freshness">
      <option value="">Any time (no filter)</option>
      <option value="d7">Last 7 days</option>
      <option value="m1" selected>Last 30 days</option>
      <option value="m3">Last 90 days</option>
      <option value="y1">This year</option>
    </select>
    <label class="row" style="gap:6px; align-items:center;">
      <input type="checkbox" id="usBias" checked /> U.S. focus
    </label>
    <button id="go">Search</button>
  </div>

  <div id="status" class="small" style="margin-top:8px;"></div>

  <div class="toolbar hidden" id="pagerTop">
    <button id="prev">◀ Prev</button>
    <div id="counts" class="small"></div>
    <button id="next">Next ▶</button>
  </div>

  <div id="results" class="results"></div>

  <div class="toolbar hidden" id="pagerBottom">
    <button id="prev2">◀ Prev</button>
    <div id="counts2" class="small"></div>
    <button id="next2">Next ▶</button>
  </div>

  <div id="error" class="error"></div>

  <details style="margin-top:16px;">
    <summary><b>Self‑tests</b> (make sure keys are clean + URLs look right)</summary>
    <div id="tests" class="small"></div>
  </details>

  <script>
    // =============================
    // 1) KEY STORAGE (DEV‑ONLY)
    // =============================
    // We keep keys in memory for this demo. Nothing is persisted.
    // Paste your API key & CX above, click "Use keys" — we'll sanitize them.

    let API_KEY = '';
    let CX_ID = '';

    function normalizeKey(s) {
      // Trim and remove any newlines/whitespace inside the string.
      return (s || '').toString().trim().replace(/[\s\r\n]+/g, '');
    }

    // =============================
    // 2) SIMPLE STATE
    // =============================
    let startIndex = 1; // 1-based index for paging

    // =============================
    // 3) HOOK UP UI
    // =============================
    const el = (id) => document.getElementById(id);
    const apiKeyInput = el('apiKey');
    const cxIdInput = el('cxId');
    const saveBtn = el('saveKeys');

    const qInput = el('q');
    const freshnessSelect = el('freshness');
    const usBias = el('usBias');
    const goBtn = el('go');
    const prevBtn = el('prev');
    const nextBtn = el('next');
    const prevBtn2 = el('prev2');
    const nextBtn2 = el('next2');
    const resultsDiv = el('results');
    const errorDiv = el('error');
    const statusDiv = el('status');
    const pagerTop = el('pagerTop');
    const pagerBottom = el('pagerBottom');
    const counts = el('counts');
    const counts2 = el('counts2');
    const testsDiv = el('tests');

    // =============================
    // 4) BUILD THE API URL
    // =============================
    function buildUrl({ q, freshness, start }) {
      const params = new URLSearchParams({
        key: normalizeKey(API_KEY),
        cx: normalizeKey(CX_ID),
        q: q || '',
        num: '10',
        start: String(start || 1)
      });
      if (freshness) {
        params.set('dateRestrict', freshness); // d7 | m1 | m3 | y1
        params.set('sort', 'date');
      }
      if (usBias.checked) params.set('cr', 'countryUS');
      return 'https://www.googleapis.com/customsearch/v1?' + params.toString();
    }

    // =============================
    // 5) RENDER RESULTS
    // =============================
    function renderResults(data) {
      const items = (data && data.items) || [];
      resultsDiv.innerHTML = items.map(item => {
        const title = item.title || 'Untitled';
        const link = item.link || '#';
        const snippet = item.snippet || '';
        const displayLink = item.displayLink || '';
        return `
          <div class="item">
            <a href="${link}" target="_blank" rel="noopener">${title}</a>
            <div class="meta">${displayLink}</div>
            <div>${snippet}</div>
          </div>`;
      }).join('');

      const total = data?.searchInformation?.formattedTotalResults || '0';
      const rangeStart = data?.queries?.request?.[0]?.startIndex || 1;
      const count = items.length;
      const rangeEnd = rangeStart + count - 1;
      const text = count ? `Showing ${rangeStart}–${rangeEnd} of ~${total}` : 'No results';
      counts.textContent = text;
      counts2.textContent = text;

      const hasPrev = !!data?.queries?.previousPage;
      const hasNext = !!data?.queries?.nextPage;
      prevBtn.disabled = !hasPrev; prevBtn2.disabled = !hasPrev;
      nextBtn.disabled = !hasNext; nextBtn2.disabled = !hasNext;

      pagerTop.classList.toggle('hidden', !count);
      pagerBottom.classList.toggle('hidden', !count);
    }

    function showError(msg) { errorDiv.textContent = msg || ''; }

    async function doSearch() {
      showError('');
      const q = qInput.value.trim();
      if (!q) { showError('Type something to search.'); return; }
      if (!normalizeKey(API_KEY) || !normalizeKey(CX_ID)) {
        showError('Paste your API key and CX ID above, then click \"Use keys\".');
        return;
      }
      statusDiv.textContent = 'Searching…';

      try {
        const url = buildUrl({ q, freshness: freshnessSelect.value, start: startIndex });
        const res = await fetch(url);
        const data = await res.json();
        if (!res.ok) throw new Error(data.error?.message || 'Request failed');
        renderResults(data);
        statusDiv.textContent = '';
      } catch (err) {
        console.error(err);
        showError(err.message);
        statusDiv.textContent = '';
      }
    }

    // =============================
    // 6) WIRE EVENTS
    // =============================
    saveBtn.addEventListener('click', () => {
      API_KEY = normalizeKey(apiKeyInput.value);
      CX_ID = normalizeKey(cxIdInput.value);
      // Run tests after saving keys
      runTests();
    });

    const triggerSearch = () => { startIndex = 1; doSearch(); };
    goBtn.addEventListener('click', triggerSearch);
    qInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') triggerSearch(); });
    freshnessSelect.addEventListener('change', triggerSearch);

    function page(delta) { startIndex = Math.max(1, startIndex + delta); doSearch(); }
    prevBtn.addEventListener('click', () => page(-10));
    nextBtn.addEventListener('click', () => page(10));
    prevBtn2.addEventListener('click', () => page(-10));
    nextBtn2.addEventListener('click', () => page(10));

    // =============================
    // 7) SELF TESTS (lightweight)
    // =============================
    function test(name, fn) {
      try {
        const ok = fn();
        return `<div class="${ok ? 'pass' : 'fail'}">${ok ? '✓' : '✗'} ${name}</div>`;
      } catch (e) {
        return `<div class="fail">✗ ${name} — ${e.message}</div>`;
      }
    }

    function runTests() {
      const nKey = normalizeKey(API_KEY);
      const nCx  = normalizeKey(CX_ID);
      const rows = [];
      rows.push(test('API key has no whitespace/newlines', () => nKey.length > 0 && !/\s/.test(nKey)));
      rows.push(test('CX ID has no whitespace/newlines', () => nCx.length > 0 && !/\s/.test(nCx)));
      rows.push(test('Build URL includes dateRestrict when set', () => {
        const url = buildUrl({ q: 'test', freshness: 'm1', start: 1 });
        return url.includes('dateRestrict=m1') && url.includes('sort=date');
      }));
      rows.push(test('Build URL excludes dateRestrict when blank', () => {
        const url = buildUrl({ q: 'test', freshness: '', start: 1 });
        return !/dateRestrict=/.test(url);
      }));
      rows.push(test('U.S. bias adds cr=countryUS', () => {
        usBias.checked = true;
        const url = buildUrl({ q: 'test', freshness: 'd7', start: 1 });
        return url.includes('cr=countryUS');
      }));
      rows.push(test('Paging parameter changes with startIndex', () => {
        const u1 = buildUrl({ q: 'x', freshness: '', start: 1 });
        const u2 = buildUrl({ q: 'x', freshness: '', start: 11 });
        return u1 !== u2 && /start=1(?!\d)/.test(u1) && /start=11/.test(u2);
      }));
      testsDiv.innerHTML = rows.join('');
    }

    // Seed example query and run tests initially
    qInput.value = 'permit lottery yosemite';
    runTests();
  </script>
</body>
</html>
